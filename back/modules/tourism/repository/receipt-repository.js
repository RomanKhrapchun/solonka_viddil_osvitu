const { sqlRequest } = require("../../../helpers/database");
const { buildWhereCondition } = require("../../../utils/function");
const { getSafeSortField, validateSortDirection } = require("../../../utils/constants");

// –†–æ–∑—à–∏—Ä–µ–Ω—ñ –ø–æ–ª—è –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π –∑ —É—Å—ñ–º–∞ –Ω–æ–≤–∏–º–∏ –ø–æ–ª—è–º–∏
const displayReceiptFields = [
    'id', 'identifier', 'name', 'date', 'counter', 'created_at', 'updated_at',
    'gender', 'citizenship', 'arrival_date', 'departure_date', 'amount'
];

// –î–æ–∑–≤–æ–ª–µ–Ω—ñ –ø–æ–ª—è –¥–ª—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
const allowedReceiptSortFields = [
    'id', 'identifier', 'name', 'date', 'counter', 'created_at', 'updated_at',
    'gender', 'citizenship', 'arrival_date', 'departure_date', 'amount'
];

class ReceiptRepository {

    // üîç –ü–æ—à—É–∫ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó –ø–æ identifier
    async getReceiptByIdentifier(identifier) {
        const sql = `
            SELECT ${displayReceiptFields.join(', ')} 
            FROM tourism.receipt 
            WHERE identifier = $1
        `;
        const result = await sqlRequest(sql, [identifier]);
        return result.length > 0 ? result[0] : null;
    }

    // üìà –ó–±—ñ–ª—å—à–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Å–∫–∞–Ω—É–≤–∞–Ω—å
    async incrementCounter(identifier) {
        const sql = `
            UPDATE tourism.receipt 
            SET counter = counter + 1, updated_at = CURRENT_TIMESTAMP
            WHERE identifier = $1
            RETURNING counter
        `;
        const result = await sqlRequest(sql, [identifier]);
        return result.length > 0 ? result[0].counter : 0;
    }

    // üìÑ –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó –ø–æ ID (–ø–µ—Ä–µ–π–º–µ–Ω–æ–≤–∞–Ω–∏–π –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ Service)
    async getReceiptByReceiptId(receiptId, fields = displayReceiptFields) {
        const sql = `
            SELECT ${fields.join(', ')} 
            FROM tourism.receipt 
            WHERE id = $1
        `;
        const result = await sqlRequest(sql, [receiptId]);
        return result;
    }

    // üìÑ –ó–∞–ª–∏—à–∞—î–º–æ —Å—Ç–∞—Ä–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ—ó —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
    async getReceiptById(receiptId) {
        const sql = `
            SELECT ${displayReceiptFields.join(', ')} 
            FROM tourism.receipt 
            WHERE id = $1
        `;
        const result = await sqlRequest(sql, [receiptId]);
        return result.length > 0 ? result[0] : null;
    }

    // üîç –ü–æ—à—É–∫ –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏ (–Ω–æ–≤–∏–π –º–µ—Ç–æ–¥ –∑–∞ –∑—Ä–∞–∑–∫–æ–º DebtorRepository)
    async findReceiptByFilter(limit, offset, title, allowedFields, fields, sortBy, sortDirection) {
        // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —É–º–æ–≤ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è
        let whereConditions = [];
        let queryParams = [];
        let paramIndex = 1;

        // –ü–æ—à—É–∫ –ø–æ title (–∑–∞–≥–∞–ª—å–Ω–∏–π –ø–æ—à—É–∫ –ø–æ name –∞–±–æ identifier)
        if (title) {
            whereConditions.push(`(name ILIKE $${paramIndex} OR identifier ILIKE $${paramIndex + 1})`);
            queryParams.push(`%${title}%`, `%${title}%`);
            paramIndex += 2;
        }

        // –û–±—Ä–æ–±–∫–∞ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
        Object.keys(allowedFields).forEach(key => {
            const value = allowedFields[key];
            if (value !== null && value !== undefined && value !== '') {
                switch (key) {
                    case 'identifier':
                        whereConditions.push(`identifier ILIKE $${paramIndex}`);
                        queryParams.push(`%${value}%`);
                        paramIndex++;
                        break;
                    
                    case 'name':
                        whereConditions.push(`name ILIKE $${paramIndex}`);
                        queryParams.push(`%${value}%`);
                        paramIndex++;
                        break;
                    
                    case 'gender':
                        whereConditions.push(`gender = $${paramIndex}`);
                        queryParams.push(value);
                        paramIndex++;
                        break;
                    
                    case 'citizenship':
                        whereConditions.push(`citizenship ILIKE $${paramIndex}`);
                        queryParams.push(`%${value}%`);
                        paramIndex++;
                        break;
                    
                    case 'date_from':
                        whereConditions.push(`date >= $${paramIndex}`);
                        queryParams.push(value);
                        paramIndex++;
                        break;
                    
                    case 'date_to':
                        whereConditions.push(`date <= $${paramIndex}`);
                        queryParams.push(value);
                        paramIndex++;
                        break;
                    
                    case 'arrival_date_from':
                        whereConditions.push(`arrival_date >= $${paramIndex}`);
                        queryParams.push(value);
                        paramIndex++;
                        break;
                    
                    case 'arrival_date_to':
                        whereConditions.push(`arrival_date <= $${paramIndex}`);
                        queryParams.push(value);
                        paramIndex++;
                        break;
                    
                    case 'departure_date_from':
                        whereConditions.push(`departure_date >= $${paramIndex}`);
                        queryParams.push(value);
                        paramIndex++;
                        break;
                    
                    case 'departure_date_to':
                        whereConditions.push(`departure_date <= $${paramIndex}`);
                        queryParams.push(value);
                        paramIndex++;
                        break;
                    
                    case 'counter_from':
                        if (value !== null && value !== undefined && value !== '') {
                            whereConditions.push(`counter >= ${paramIndex}`);
                            queryParams.push(parseInt(value));
                            paramIndex++;
                        }
                        break;
                    
                    case 'counter_to':
                        if (value !== null && value !== undefined && value !== '') {
                            whereConditions.push(`counter <= ${paramIndex}`);
                            queryParams.push(parseInt(value));
                            paramIndex++;
                        }
                        break;
                    
                    case 'amount_from':
                        if (value !== null && value !== undefined && value !== '') {
                            whereConditions.push(`amount >= ${paramIndex}`);
                            queryParams.push(parseFloat(value));
                            paramIndex++;
                        }
                        break;
                    
                    case 'amount_to':
                        if (value !== null && value !== undefined && value !== '') {
                            whereConditions.push(`amount <= ${paramIndex}`);
                            queryParams.push(parseFloat(value));
                            paramIndex++;
                        }
                        break;
                }
            }
        });

        const whereClause = whereConditions.length > 0 ? `WHERE ${whereConditions.join(' AND ')}` : '';
        
        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
        const safeSortBy = allowedReceiptSortFields.includes(sortBy) ? sortBy : 'counter';
        const safeSortDirection = sortDirection === 'asc' ? 'ASC' : 'DESC';

        // –ó–∞–ø–∏—Ç –¥–ª—è –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É
        const countSql = `
            SELECT COUNT(*) as count
            FROM tourism.receipt 
            ${whereClause}
        `;
        
        // –û—Å–Ω–æ–≤–Ω–∏–π –∑–∞–ø–∏—Ç
        const mainSql = `
            SELECT ${fields.join(', ')}
            FROM tourism.receipt 
            ${whereClause}
            ORDER BY ${safeSortBy} ${safeSortDirection}
            LIMIT $${paramIndex} OFFSET $${paramIndex + 1}
        `;
        
        queryParams.push(limit, offset);
        
        // –í–∏–∫–æ–Ω—É—î–º–æ –æ–±–∏–¥–≤–∞ –∑–∞–ø–∏—Ç–∏
        const [countResult, dataResult] = await Promise.all([
            sqlRequest(countSql, queryParams.slice(0, -2)), // –±–µ–∑ LIMIT —Ç–∞ OFFSET
            sqlRequest(mainSql, queryParams)
        ]);
        
        return [{
            count: parseInt(countResult[0].count),
            data: dataResult
        }];
    }

    // üìã –†–æ–∑—à–∏—Ä–µ–Ω–∏–π —Å–ø–∏—Å–æ–∫ –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π –∑ —É—Å—ñ–º–∞ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏
    async getReceiptsList(page, limit, sortBy, sortDirection, filters) {
        // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —É–º–æ–≤ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è –∑ —É—Å—ñ–º–∞ –Ω–æ–≤–∏–º–∏ –ø–æ–ª—è–º–∏
        let whereConditions = [];
        let queryParams = [];
        let paramIndex = 1;
        console.log('filters', filters);
        // –û—Å–Ω–æ–≤–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
        if (filters.identifier) {
            whereConditions.push(`identifier ILIKE $${paramIndex}`);
            queryParams.push(`%${filters.identifier}%`);
            paramIndex++;
        }

        if (filters.name) {
            whereConditions.push(`name ILIKE $${paramIndex}`);
            queryParams.push(`%${filters.name}%`);
            paramIndex++;
        }

        if (filters.gender) {
            whereConditions.push(`gender = $${paramIndex}`);
            queryParams.push(filters.gender);
            paramIndex++;
        }

        if (filters.citizenship) {
            whereConditions.push(`citizenship ILIKE $${paramIndex}`);
            queryParams.push(`%${filters.citizenship}%`);
            paramIndex++;
        }

        // –§—ñ–ª—å—Ç—Ä–∏ –ø–æ –¥–∞—Ç–∞—Ö
        if (filters.date_from) {
            whereConditions.push(`date >= $${paramIndex}`);
            queryParams.push(filters.date_from);
            paramIndex++;
        }

        if (filters.date_to) {
            whereConditions.push(`date <= $${paramIndex}`);
            queryParams.push(filters.date_to);
            paramIndex++;
        }

        if (filters.arrival_date_from) {
            whereConditions.push(`arrival_date >= $${paramIndex}`);
            queryParams.push(filters.arrival_date_from);
            paramIndex++;
        }

        if (filters.arrival_date_to) {
            whereConditions.push(`arrival_date <= $${paramIndex}`);
            queryParams.push(filters.arrival_date_to);
            paramIndex++;
        }

        if (filters.departure_date_from) {
            whereConditions.push(`departure_date >= $${paramIndex}`);
            queryParams.push(filters.departure_date_from);
            paramIndex++;
        }

        if (filters.departure_date_to) {
            whereConditions.push(`departure_date <= $${paramIndex}`);
            queryParams.push(filters.departure_date_to);
            paramIndex++;
        }

        // –§—ñ–ª—å—Ç—Ä–∏ –ø–æ counter
        if (filters.counter_from !== undefined) {
            whereConditions.push(`counter >= $${paramIndex}`);
            queryParams.push(filters.counter_from);
            paramIndex++;
        }

        if (filters.counter_to !== undefined) {
            whereConditions.push(`counter <= $${paramIndex}`);
            queryParams.push(filters.counter_to);
            paramIndex++;
        }

        // –§—ñ–ª—å—Ç—Ä–∏ –ø–æ —Å—É–º—ñ
        if (filters.amount !== undefined) {
            whereConditions.push(`amount = ${paramIndex}`);
            queryParams.push(filters.amount);
            paramIndex++;
        }

        const whereClause = whereConditions.length > 0 ? `WHERE ${whereConditions.join(' AND ')}` : '';
        console.log('whereClause', whereClause);
        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
        const safeSortBy = allowedReceiptSortFields.includes(sortBy) ? sortBy : 'counter';
        const safeSortDirection = sortDirection === 'asc' ? 'ASC' : 'DESC';

        // –ó–∞–ø–∏—Ç –¥–ª—è –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –∑–∞–≥–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
        const countSql = `
            SELECT COUNT(*) as total
            FROM tourism.receipt 
            ${whereClause}
        `;
        const countResult = await sqlRequest(countSql, queryParams);
        const totalItems = parseInt(countResult[0].total);

        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ offset
        const offset = (page - 1) * limit;

        // –û—Å–Ω–æ–≤–Ω–∏–π –∑–∞–ø–∏—Ç –∑ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—î—é
        const mainSql = `
            SELECT ${displayReceiptFields.join(', ')}
            FROM tourism.receipt 
            ${whereClause}
            ORDER BY ${safeSortBy} ${safeSortDirection}
            LIMIT $${paramIndex} OFFSET $${paramIndex + 1}
        `;

        queryParams.push(limit, offset);
        const items = await sqlRequest(mainSql, queryParams);

        return { items, totalItems };
    }

    // ‚ûï –†–æ–∑—à–∏—Ä–µ–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó –∑ —É—Å—ñ–º–∞ –ø–æ–ª—è–º–∏
    async createReceipt(receiptData) {
        const { 
            identifier, name, date, gender, citizenship, 
            arrival_date, departure_date, amount 
        } = receiptData;
        
        const sql = `
            INSERT INTO tourism.receipt (
                identifier, name, date, counter, gender, 
                citizenship, arrival_date, departure_date, amount
            )
            VALUES ($1, $2, $3, 0, $4, $5, $6, $7, $8)
            RETURNING ${displayReceiptFields.join(', ')}
        `;
        
        const result = await sqlRequest(sql, [
            identifier, name, date, gender, citizenship,
            arrival_date, departure_date, amount
        ]);
        return result[0];
    }

    // ‚úèÔ∏è –†–æ–∑—à–∏—Ä–µ–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó –∑ —É—Å—ñ–º–∞ –ø–æ–ª—è–º–∏
    async updateReceipt(receiptId, updateData) {
        // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–ª—ñ–≤ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
        const updateFields = [];
        const queryParams = [];
        let paramIndex = 1;

        if (updateData.identifier !== undefined) {
            updateFields.push(`identifier = $${paramIndex}`);
            queryParams.push(updateData.identifier);
            paramIndex++;
        }

        if (updateData.name !== undefined) {
            updateFields.push(`name = $${paramIndex}`);
            queryParams.push(updateData.name);
            paramIndex++;
        }

        if (updateData.date !== undefined) {
            updateFields.push(`date = $${paramIndex}`);
            queryParams.push(updateData.date);
            paramIndex++;
        }

        if (updateData.counter !== undefined) {
            updateFields.push(`counter = $${paramIndex}`);
            queryParams.push(updateData.counter);
            paramIndex++;
        }

        if (updateData.gender !== undefined) {
            updateFields.push(`gender = $${paramIndex}`);
            queryParams.push(updateData.gender);
            paramIndex++;
        }

        if (updateData.citizenship !== undefined) {
            updateFields.push(`citizenship = $${paramIndex}`);
            queryParams.push(updateData.citizenship);
            paramIndex++;
        }

        if (updateData.arrival_date !== undefined) {
            updateFields.push(`arrival_date = $${paramIndex}`);
            queryParams.push(updateData.arrival_date);
            paramIndex++;
        }

        if (updateData.departure_date !== undefined) {
            updateFields.push(`departure_date = $${paramIndex}`);
            queryParams.push(updateData.departure_date);
            paramIndex++;
        }

        if (updateData.amount !== undefined) {
            updateFields.push(`amount = $${paramIndex}`);
            queryParams.push(updateData.amount);
            paramIndex++;
        }

        // –ó–∞–≤–∂–¥–∏ –æ–Ω–æ–≤–ª—é—î–º–æ updated_at
        updateFields.push(`updated_at = CURRENT_TIMESTAMP`);
        
        // –î–æ–¥–∞—î–º–æ ID –¥–ª—è WHERE clause
        queryParams.push(receiptId);

        const sql = `
            UPDATE tourism.receipt 
            SET ${updateFields.join(', ')}
            WHERE id = $${paramIndex}
            RETURNING ${displayReceiptFields.join(', ')}
        `;

        const result = await sqlRequest(sql, queryParams);
        return result[0];
    }

    // üì• –†–æ–∑—à–∏—Ä–µ–Ω–∏–π –µ–∫—Å–ø–æ—Ä—Ç –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π –∑ —É—Å—ñ–º–∞ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏
    async exportReceipts(filters) {
        // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —É–º–æ–≤ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è (–∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –¥–æ getReceiptsList)
        let whereConditions = [];
        let queryParams = [];
        let paramIndex = 1;

        // –£—Å—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ —è–∫ —É getReceiptsList
        if (filters.identifier) {
            whereConditions.push(`identifier ILIKE $${paramIndex}`);
            queryParams.push(`%${filters.identifier}%`);
            paramIndex++;
        }

        if (filters.name) {
            whereConditions.push(`name ILIKE $${paramIndex}`);
            queryParams.push(`%${filters.name}%`);
            paramIndex++;
        }

        if (filters.gender) {
            whereConditions.push(`gender = $${paramIndex}`);
            queryParams.push(filters.gender);
            paramIndex++;
        }

        if (filters.citizenship) {
            whereConditions.push(`citizenship ILIKE $${paramIndex}`);
            queryParams.push(`%${filters.citizenship}%`);
            paramIndex++;
        }

        if (filters.date_from) {
            whereConditions.push(`date >= $${paramIndex}`);
            queryParams.push(filters.date_from);
            paramIndex++;
        }

        if (filters.date_to) {
            whereConditions.push(`date <= $${paramIndex}`);
            queryParams.push(filters.date_to);
            paramIndex++;
        }

        if (filters.arrival_date_from) {
            whereConditions.push(`arrival_date >= $${paramIndex}`);
            queryParams.push(filters.arrival_date_from);
            paramIndex++;
        }

        if (filters.arrival_date_to) {
            whereConditions.push(`arrival_date <= $${paramIndex}`);
            queryParams.push(filters.arrival_date_to);
            paramIndex++;
        }

        if (filters.departure_date_from) {
            whereConditions.push(`departure_date >= $${paramIndex}`);
            queryParams.push(filters.departure_date_from);
            paramIndex++;
        }

        if (filters.departure_date_to) {
            whereConditions.push(`departure_date <= $${paramIndex}`);
            queryParams.push(filters.departure_date_to);
            paramIndex++;
        }

        if (filters.counter_from !== undefined) {
            whereConditions.push(`counter >= $${paramIndex}`);
            queryParams.push(filters.counter_from);
            paramIndex++;
        }

        if (filters.counter_to !== undefined) {
            whereConditions.push(`counter <= $${paramIndex}`);
            queryParams.push(filters.counter_to);
            paramIndex++;
        }

        if (filters.amount_from !== undefined) {
            whereConditions.push(`amount >= $${paramIndex}`);
            queryParams.push(filters.amount_from);
            paramIndex++;
        }

        if (filters.amount_to !== undefined) {
            whereConditions.push(`amount <= $${paramIndex}`);
            queryParams.push(filters.amount_to);
            paramIndex++;
        }

        const whereClause = whereConditions.length > 0 ? `WHERE ${whereConditions.join(' AND ')}` : '';

        // –ï–∫—Å–ø–æ—Ä—Ç –≤—Å—ñ—Ö –∑–∞–ø–∏—Å—ñ–≤ –±–µ–∑ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—ó
        const sql = `
            SELECT ${displayReceiptFields.join(', ')}
            FROM tourism.receipt 
            ${whereClause}
            ORDER BY counter DESC, created_at DESC
        `;

        return await sqlRequest(sql, queryParams);
    }

    async getScanActivitiesList(page, limit, sortBy, sortDirection, filters) {
        try {
            console.log('Repository getScanActivitiesList called with:', {
                page, limit, sortBy, sortDirection, filters
            });
    
            // –ü–æ–±—É–¥–æ–≤–∞ WHERE —É–º–æ–≤
            let whereConditions = [];
            let queryParams = [];
            let paramIndex = 1;
    
            // –§—ñ–ª—å—Ç—Ä –ø–æ –º—ñ—Å—Ü—é —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è
            if (filters.scan_location) {
                whereConditions.push(`s.scan_location ILIKE $${paramIndex}`);
                queryParams.push(`%${filters.scan_location}%`);
                paramIndex++;
            }
    
            // –§—ñ–ª—å—Ç—Ä –ø–æ identifier –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó
            if (filters.identifier) {
                whereConditions.push(`r.identifier ILIKE $${paramIndex}`);
                queryParams.push(`%${filters.identifier}%`);
                paramIndex++;
            }
    
            // –§—ñ–ª—å—Ç—Ä –ø–æ —ñ–º–µ–Ω—ñ
            if (filters.name) {
                whereConditions.push(`r.name ILIKE $${paramIndex}`);
                queryParams.push(`%${filters.name}%`);
                paramIndex++;
            }
    
            // –û–±—Ä–æ–±–∫–∞ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –ø–æ –¥–∞—Ç—ñ —ñ —á–∞—Å—É —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è
            if (filters.scan_date_from) {
                const dateFrom = filters.scan_time_from 
                    ? `${filters.scan_date_from} ${filters.scan_time_from}` 
                    : `${filters.scan_date_from} 00:00:00`;
                whereConditions.push(`s.scan_date >= $${paramIndex}`);
                queryParams.push(dateFrom);
                paramIndex++;
            }
    
            if (filters.scan_date_to) {
                const dateTo = filters.scan_time_to 
                    ? `${filters.scan_date_to} ${filters.scan_time_to}` 
                    : `${filters.scan_date_to} 23:59:59`;
                whereConditions.push(`s.scan_date <= $${paramIndex}`);
                queryParams.push(dateTo);
                paramIndex++;
            }
    
            const whereClause = whereConditions.length > 0 ? `WHERE ${whereConditions.join(' AND ')}` : '';
    
            // –î–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –ø–æ counter –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ CTE, –æ—Å–∫—ñ–ª—å–∫–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –ø–æ –æ–±—á–∏—Å–ª–µ–Ω–æ–º—É –ø–æ–ª—é
            let counterFilterClause = '';
            let counterParams = [];
            let counterParamIndex = paramIndex;
    
            if (filters.counter_from !== undefined && filters.counter_from !== null) {
                counterFilterClause += ` AND counter_at_scan_time >= $${counterParamIndex}`;
                counterParams.push(filters.counter_from);
                counterParamIndex++;
            }
    
            if (filters.counter_to !== undefined && filters.counter_to !== null) {
                counterFilterClause += ` AND counter_at_scan_time <= $${counterParamIndex}`;
                counterParams.push(filters.counter_to);
                counterParamIndex++;
            }
    
            // –ë–∞–∑–æ–≤–∏–π CTE –∑–∞–ø–∏—Ç –∑ –æ–±—á–∏—Å–ª–µ–Ω–∏–º counter_at_scan_time
            const baseCTE = `
                WITH scan_data AS (
                    SELECT 
                        s.scan_location,
                        r.identifier,
                        r.name,
                r.counter, 
                        r.counter - (COUNT(*) OVER (PARTITION BY r.identifier) - ROW_NUMBER() OVER (PARTITION BY r.identifier ORDER BY s.scan_date ASC)) AS counter_at_scan_time,
                        s.scan_date,
                        s.receipt_id
                    FROM tourism.scan_activity s
                    JOIN tourism.receipt r ON s.receipt_id = r.id
                    ${whereClause}
                )
            `;
    
            // –ó–∞–ø–∏—Ç –¥–ª—è –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –∑–∞–≥–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
            const countQuery = `
                ${baseCTE}
                SELECT COUNT(*) as total
                FROM scan_data
                WHERE 1=1 ${counterFilterClause}
            `;
    
            const countQueryParams = [...queryParams, ...counterParams];
            console.log('Count query:', countQuery);
            console.log('Count params:', countQueryParams);
            
            const countResult = await sqlRequest(countQuery, countQueryParams);
            const totalItems = parseInt(countResult[0]?.total || 0);
    
            // –ü–æ–±—É–¥–æ–≤–∞ ORDER BY
            let orderByClause;
            switch (sortBy) {
                case 'scan_location':
                    orderByClause = `scan_location ${sortDirection}`;
                    break;
                case 'identifier':
                    orderByClause = `identifier ${sortDirection}`;
                    break;
                case 'name':
                    orderByClause = `name ${sortDirection}`;
                    break;
                case 'counter':
                orderByClause = `counter ${sortDirection}`;
                break;
            case 'counter_at_scan_time':
                orderByClause = `counter_at_scan_time ${sortDirection}`;
                break;
                case 'scan_date':
                default:
                    orderByClause = `scan_date ${sortDirection}`;
                    break;
            }
    
            // –ó–∞–ø–∏—Ç –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—î—é
            const offset = (page - 1) * limit;
            
            const dataQuery = `
                ${baseCTE}
                SELECT 
                    scan_location,
                    identifier,
                    name,
                    counter,
            counter_at_scan_time,
                    scan_date,
                    receipt_id
                FROM scan_data
                WHERE 1=1 ${counterFilterClause}
                ORDER BY ${orderByClause}
                LIMIT $${counterParamIndex} OFFSET $${counterParamIndex + 1}
            `;
    
            const dataParams = [...queryParams, ...counterParams, limit, offset];
    
            console.log('Data query:', dataQuery);
            console.log('Data params:', dataParams);
    
            const items = await sqlRequest(dataQuery, dataParams);
    
            console.log(`Found ${totalItems} total scan activities, returning ${items?.length || 0} items`);
    
            return {
                items: items || [],
                totalItems
            };
    
        } catch (error) {
            console.error('Error in getScanActivitiesList repository:', error);
            throw new Error(`Database error: ${error.message}`);
        }
    
    }
}

const receiptRepository = new ReceiptRepository();
module.exports = receiptRepository;